{% load static %} {% load form_tags %}

<form
  id="updateStatusForm"
  class="modal-content"
  hx-post="{% url 'udpate_status' opportunity.id %}?{{ request.GET.urlencode }}"
  hx-target="#dialog"
  hx-include="#opportunityForm"
  novalidate
>
  {% csrf_token %}
  <div class="modal-header">
    <h5 class="modal-title" id="updateStatusModalLabel">
      {% if form.status.value == 1 %} Go/No-Go {% elif form.status.value == 5 %}
      Result{% endif %}
    </h5>
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="modal"
      aria-label="Close"
    ></button>
  </div>
  <div class="modal-body">
    <div class="card">
      <div class="card-body">
        <div class="mb-3">
          {% for choice in filtered_status %}
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="status"
            id="status_{{choice.0}}" value="{{choice.0}}" {% if
            update_status_form.data.status == choice.0 or
            update_status_form.instance.status == choice.0 %}checked{% endif %}>
            <label class="form-check-label" for="status_{{choice.0}}"
              >{{choice.1}}</label
            >
          </div>
          {% endfor %} {%if update_status_form.status.errors%}
          <div class="text-danger">
            {{update_status_form.status.errors|striptags}}
          </div>
          {%endif%}
        </div>

        <div class="mb-3 onlyForGo">
          <div class="input-group">
            <div class="input-group-text">Lead Unit</div>
            {{update_status_form.lead_unit|add_class:"form-select"}}
          </div>
          {%if update_status_form.lead_unit.errors%}
          <div class="text-danger">
            {{update_status_form.lead_unit.errors|striptags}}
          </div>
          {%endif%}
        </div>

        <div class="mb-3 onlyForGo">
          <div class="input-group">
            <div class="input-group-text">Proposal Lead</div>
            {{update_status_form.proposal_lead|add_class:"form-select"}}
          </div>
          {%if update_status_form.proposal_lead.errors%}
          <div class="text-danger">
            {{update_status_form.proposal_lead.errors|striptags}}
          </div>
          {%endif%}
        </div>

        <div class="mb-3" id="result_date_container">
          <div class="form-floating">
            {{update_status_form.result_date|add_class:"form-control"}}
            <label for="result_date" class="form-label">Result Date</label>
          </div>
          {%if update_status_form.result_date.errors%}
          <div class="text-danger">
            {{update_status_form.result_date.errors|striptags}}
          </div>
          {%endif%}
        </div>
        {% with
        selected_status=update_status_form.data.status|default:form.status.value
        %} {% if selected_status|add:0 >= 5 and selected_status|add:0 <= 7 %}
        <div class="mb-3 form-floating col-12">
          {{update_status_form.result_note|add_class:"form-control"}}
          <label for="result_note" class="form-label">Comment</label>
        </div>
        {%if update_status_form.result_note.errors%}
        <div class="text-danger">
          {{update_status_form.result_note.errors|striptags}}
        </div>
        {%endif%} {% endif %} {% endwith %}
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-success"
      id="confirmUpdateStatusButton"
      onclick="submitForm()"
    >
      {% if 1 <= form.status.value <= 4 %} Update Status {% elif
      form.status.value == 5 %} Update Result{% endif %} <img id="spinnerUpdate"
      src="{% static "images/bouncing-circles.svg" %}" alt=""
      style="height:25px;" class="htmx-indicator" />
    </button>
  </div>
</form>
<script>
  $(document).ready(function () {
    $('input[name="status"]')
      .on("change", function () {
        const selectedStatus = $("input[name='status']:checked").val();

        if (selectedStatus === "2") {
          // "Go" corresponds to value 2
          $(".onlyForGo").show(); // Show the control
        } else {
          $(".onlyForGo").hide(); // Hide the control
        }

        // Update button text based on selected status
        if (selectedStatus === "11") {
          $("#confirmUpdateStatusButton").text("Transfer to RFP");
        } else if ({{ form.status.value }} <= 4) {
          $("#confirmUpdateStatusButton").text("Update Status");
        } else {
          $("#confirmUpdateStatusButton").text("Update Result");
        }

        // Show the result date field only for the statuses Lost, Won, Cancelled and Assumed Lost
        if (["6", "7", "8", "9"].includes(selectedStatus)) {
          $("#result_date_container").show();

        } else {
          $("#result_date_container").hide();

        }

        // Update form action based on selected status
        updateFormAction();
      })
      .change();

    // Also set the form action immediately when modal loads
    updateFormAction();
  });
  function updateFormAction() {
    const form = document.getElementById('updateStatusForm');
    const selectedStatus = $("input[name='status']:checked").val();
    const queryString = form.getAttribute('data-query-string');

    console.log("Updating form action. Selected status:", selectedStatus);

    if (selectedStatus === "11") {
      // If Transfer to RFP is selected, set action to transfer URL
      console.log("Setting transfer URL");
      form.setAttribute('hx-post', '{% url "transfer_opportunity" opportunity.id %}');
    } else {
      // For all other statuses, use the regular update URL
      console.log("Setting regular update URL");
      const baseUrl = '{% url "udpate_status" opportunity.id %}';
      const fullUrl = queryString ? `${baseUrl}?${queryString}` : baseUrl;
      form.setAttribute('hx-post', fullUrl);
    }

    console.log("Form action is now:", form.getAttribute('hx-post'));
  }

  function submitForm() {
    // Make sure form action is up to date
    updateFormAction();

    const form = document.getElementById('updateStatusForm');
    const selectedStatus = $("input[name='status']:checked").val();
    console.log("Submitting form with status:", selectedStatus);
    console.log("Form action URL:", form.getAttribute('hx-post'));

    if (selectedStatus === "11") {
      // For transfer, use fetch to ensure we get the redirect
      console.log("Using fetch for transfer");

      // Disable the button and show spinner
      $("#confirmUpdateStatusButton").prop("disabled", true);
      $("#spinnerUpdate").removeClass("d-none");

      fetch(form.getAttribute('hx-post'), {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        credentials: 'same-origin'
      })
      .then(response => {
        console.log("Transfer response:", response);
        // Get redirect URL from header
        const redirectUrl = response.headers.get('HX-Redirect');
        if (redirectUrl) {
          window.location.href = redirectUrl;
        } else {
          // Fallback
          window.location.href = "{% url 'new_opportunity' %}?source_id={{ opportunity.id }}&is_transfer=true";
        }
      });
    } else {
      // For normal update, submit the form and let HTMX handle it
      console.log("Using HTMX for regular update");
      htmx.trigger('#updateStatusForm', 'submit');
    }
  }
</script>
